<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Create Workout</title>
  <link href="https://fonts.googleapis.com/css?family=Rubik:300,400&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Archivo+Narrow&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Telex&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="wrapper">
    <div class="title">
      <h1>My workout</h1>
      <P>This is my awesome workout</P>
    </div>
    <div class="custom-workout-form">
      <div class="input-wrapper">
        <label for="workout-name">Workout name (i.e. My awesome leg day)</label>
        <input class="form-element" id="workout-name" />
      </div>
      <div class="input-wrapper">
        <label for="workout-description">Workout description (optional)</label>
        <input class="form-element" id="workout-description" />
      </div>
      <h2>Exercises</h2>
      <template id="dropdown-template">
        <div class="dropdown">
          <span>Select action</span>
          <span class="dropdown-button form-element" tabindex="0">View listed actions</span>
          <!-- TO DO: add triangle icon to show dropdown -->
          <div class="dropdown-content">
            <input class="dropdown-search form-element" placeholder="Search..."/>
            <ul>
              <li class="dropdown-option selected" data-exercise="other">Add your own exercise</li>
              <li class="dropdown-option" data-exercise="0">Rest</li>
              <li class="dropdown-option" data-exercise="1">Bicep Curls</li>
              <li class="dropdown-option" data-exercise="2">Push-ups</li>
              <li class="dropdown-option" data-exercise="3">Lateral Shoulder Raises</li>
              <li class="dropdown-option" data-exercise="4">Dumbbell Rows, Left Arm</li>
              <li class="dropdown-option" data-exercise="5">Dumbbell Rows, Right Arm</li>
            </ul>
          </div>
        </div>
        <div class="input-wrapper">
          <label for="workout-duration">Duration in seconds</label>
          <input class="form-element" id="workout-duration" />
        </div>
      </template>
      
      
      <button class="button add-exercise">add exercise</button>
      
      
      
    </div>
    <footer>
      <span>Just a little HIIT timer</span>
      <span>Created by Nancy Huynh</span>
    </footer>
  </div>
  
  <script>    
    let exercises = [];
    
    /**** UTILITY FUNCTIONS ****/
    const getParentNode = (node, className) => {
      let parent = node.parentNode;
      if(parent.matches(`.${className}`)) {
        return parent;
      }
      else if(parent.matches('body')) {
        return false;
      }
      else {
        return getParentNode(parent, className);
      }
    }
    
    const removeAllChildren = (node) => {
      while(node.firstChild) {
        node.removeChild(node.firstChild);
      }
    }
    
    
    /**** USER-RELATED FUNCTIONS ****/
    const searchExercises = (query) => {
      try {
        const regex = new RegExp(query, 'gi');
        return exercises.filter(exercise => exercise.match(regex));
      }
      catch(err) {
        console.error(err);
        return [];
      }
    }
    
    /**** DOM MODIFICATION FUNCTIONS ****/
    
    const replicateDropdown = () => document.querySelector('#dropdown-template').content.cloneNode(true);
    
    const addDropdown = () => {
      let addExerciseButton = document.querySelector('.add-exercise');
      addExerciseButton.parentNode.insertBefore(replicateDropdown(), addExerciseButton);
    }
    
    const createOtherInput = () => {
      const input = document.createElement('input');
      const div = document.createElement('div');
      const label = document.createElement('label');
      div.classList.add('input-wrapper', 'other-exercise-wrapper');
      input.classList.add('form-element');
      label.textContent = "Exercise name";
      div.appendChild(label);
      div.appendChild(input);
      return div;
    }
    
    const displayOptions = (optionsArray) => {      
      return optionsArray.reduce((fragment, option, index) => {
        let li = document.createElement('li');
        li.classList.add('dropdown-option');
//        if(index === 0) li.classList.add('selected');
        li.dataset.exercise = option === "Add your own exercise" ? "other" : 1; 
        // TO DO: pull in exercise id from feed
        li.textContent = option;
        fragment.appendChild(li);
        return fragment;
      }, document.createDocumentFragment());
    }

    /**** EVENT HANDLER FUNCTIONS ****/    
    
    const handleDropdownButton = (e) => {
      if(!e.target.matches('.dropdown-button')) return;
      const currentDropdown = getParentNode(e.target, 'dropdown');
      currentDropdown.querySelector('.dropdown-content').classList.toggle('show');
    }
    
    const handleOptions = (e) => {
      if(!e.target.matches('.dropdown-option')) return;
      const selected = e.target;
      let currentDropdown = getParentNode(selected, 'dropdown');
      currentDropdown.querySelector('.dropdown-button').textContent = selected.textContent;
      
      let other = currentDropdown.querySelector('.other-exercise-wrapper');
      if(selected.dataset.exercise === "other") {
        if(!other) {
          other = createOtherInput()
          currentDropdown.appendChild(other);
        }
        other.querySelector('input').focus();
      }
      else {
        if(other) other.parentNode.removeChild(other);
        currentDropdown.querySelector('.dropdown-button').focus();
      }
      currentDropdown.querySelector('.dropdown-content').classList.remove('show');
    }
    
    const handleAddExerciseButton = (e) => {
      if(!e.target.matches('.add-exercise')) return;
      addDropdown();
    }
    
    const handleSearchInput = (e) => {
      if(!e.target.matches('.dropdown-search')) return;

      if([40, 38].includes(e.keyCode)) { 
        e.preventDefault();
        let currentDropdown = getParentNode(e.target, 'dropdown');
        let selected = currentDropdown.querySelector('.dropdown-content li.selected');
        console.log(selected);
        if(selected && selected.nextElementSibling && e.keyCode === 40) { // down
          
          selected.classList.remove('selected');
          selected.nextElementSibling.classList.add('selected');
          selected.scrollIntoView();
        }
        if(selected && selected.previousElementSibling && e.keyCode === 38) { // up
          selected.classList.remove('selected');
          selected.previousElementSibling.classList.add('selected');
          selected.previousElementSibling.scrollIntoView();
        }
        return;
      }
  
      
      // enter key functionality
      
      
      let list = displayOptions(searchExercises(e.target.value));
      let dropdownList = getParentNode(e.target, 'dropdown')
                              .querySelector('.dropdown-content ul');
      removeAllChildren(dropdownList);
      dropdownList.appendChild(list);
    }
    
    document.addEventListener('focusin', (e) => {
      if(e.target.matches('.dropdown-search')) return;
//      dropdown.classList.remove('selected'); // fix
    });
    
    document.addEventListener('click', (e) => {
      if(e.target.matches('.dropdown-button')){
        handleDropdownButton(e);
        return;
      }
      
      if(e.target.matches('.dropdown-option')){
        handleOptions(e);
        return;
      }
      
      if(e.target.matches('.dropdown-search')) return;
      
      if(e.target.matches('.add-exercise')) {
        handleAddExerciseButton(e);
      }
      
//      dropdownContent.classList.remove('show'); //fix
//      dropdown.classList.remove('selected');
    });
    
    document.addEventListener('keyup', e => {
      if(!e.target.matches('.dropdown-search')) return;
      handleSearchInput(e);
    })
    
    /**** INITIALIZE ****/
    ;(function() {
      addDropdown();
      exercises = [...document.querySelectorAll('.dropdown-content ul li')].map(li => li.textContent);
    })();
  </script>
  
</body>
</html>
